<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GitHub Projects - Nanda</title>
  <meta name="description" content="Автоматически подгружаемые публичные репозитории GitHub" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0d0d0d;
      --accent:#33ff33;
      --muted: rgba(51,255,51,0.75);
      --card: rgba(255,255,255,0.02);
      --max-w:1100px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: 'Roboto Mono', monospace;
      background:var(--bg);
      color:var(--accent);
      padding:2rem;
      display:flex;
      justify-content:center;
    }
    main{width:100%;max-width:var(--max-w)}
    header nav ul{display:flex;gap:1rem;list-style:none;margin-bottom:1.2rem;flex-wrap:wrap}
    a{color:var(--accent);text-decoration:none}
    a:focus{outline:2px dashed var(--accent);outline-offset:3px}
    h1{font-size:1.6rem;margin-bottom:0.6rem}
    .controls{display:flex;gap:0.6rem;align-items:center;margin-bottom:1rem}
    .btn{background:transparent;border:1px solid var(--accent);padding:0.4rem 0.6rem;border-radius:6px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    #repo-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
    .project{border-left:2px solid var(--accent);padding:1rem;background:var(--card);border-radius:6px}
    .project h3{font-size:1.05rem;margin-bottom:0.3rem}
    .project p{opacity:0.85;font-size:0.95rem;margin-bottom:0.6rem}
    .repo-meta{font-size:0.85rem;opacity:0.8}
    .note{opacity:0.7;margin-top:0.6rem;font-size:0.92rem}
    .status{margin-bottom:1rem}
    .skeleton{height:72px;background:rgba(255,255,255,0.02);border-radius:6px;padding:1rem}
    @media(max-width:520px){body{padding:1rem}}
  </style>
</head>
<body>
  <main>
    <header>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
      <h1>GitHub — public repositories</h1>
    </header>

    <div class="controls">
      <!-- Конфигурация пользователя -->
      <label for="username" style="margin-right:0.4rem">Username</label>
      <input id="username" type="text" value="nanda070" style="background:transparent;border:1px solid rgba(51,255,51,0.15);padding:0.35rem;border-radius:6px;color:var(--accent)" />
      <button id="reload" class="btn" title="Reload">Reload</button>
      <button id="clearCache" class="btn" title="Clear local cache">Clear Cache</button>
      <div style="margin-left:auto;font-size:0.9rem" id="counter"></div>
    </div>

    <div id="status" class="status" role="status" aria-live="polite">Готов.</div>

    <section id="github-projects">
      <div id="repo-list" aria-live="polite" aria-busy="false">
        <!-- динамически -->
      </div>
    </section>

    <p class="note">
      Примечание: клиентский запрос к GitHub ограничен публичными rate limits. Для больших объёмов/частых запросов используйте proxy на сервере с токеном.
    </p>

  </main>

  <script>
  (function () {
    // CONFIG
    const STORAGE_KEY = 'gh_repos_cache_v1';
    const CACHE_TTL_MS = 1000 * 60 * 10; // 10 минут
    const PER_PAGE = 100; // max per GitHub REST
    const MAX_PAGES = 10;  // защита от бесконечных циклов (=> max 1000 repos)
    const USERNAME_INPUT = document.getElementById('username');
    const RELOAD_BTN = document.getElementById('reload');
    const CLEAR_BTN = document.getElementById('clearCache');
    const STATUS = document.getElementById('status');
    const CONTAINER = document.getElementById('repo-list');
    const COUNTER = document.getElementById('counter');

    // OPTIONAL: If you want to use a token, set it here.
    // WARNING: putting a token in client-side code is insecure. Prefer server proxy.
    const GITHUB_TOKEN = null; // e.g. 'ghp_xxx'   <-- НЕ храните публично

    // Utility: set status text
    function setStatus(text, isBusy = false) {
      STATUS.textContent = text;
      CONTAINER.setAttribute('aria-busy', isBusy ? 'true' : 'false');
    }

    // Utility: create project DOM node (safe)
    function createProjectNode(repo) {
      const wrap = document.createElement('div');
      wrap.className = 'project';

      const h3 = document.createElement('h3');
      const a = document.createElement('a');
      a.href = repo.html_url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = repo.name || 'Unnamed repo';
      h3.appendChild(a);

      const desc = document.createElement('p');
      desc.textContent = repo.description || 'No description provided.';

      const meta = document.createElement('div');
      meta.className = 'repo-meta';
      const stars = document.createElement('span');
      stars.textContent = `★ ${repo.stargazers_count ?? 0}`;
      const lang = document.createElement('span');
      lang.style.marginLeft = '0.6rem';
      lang.textContent = repo.language ? `• ${repo.language}` : '';
      const upd = document.createElement('span');
      upd.style.marginLeft = '0.6rem';
      if (repo.updated_at) {
        const dt = new Date(repo.updated_at);
        upd.textContent = `• updated ${dt.toLocaleDateString()}`;
      }
      meta.appendChild(stars);
      meta.appendChild(lang);
      meta.appendChild(upd);

      wrap.appendChild(h3);
      wrap.appendChild(desc);
      wrap.appendChild(meta);
      return wrap;
    }

    // Show skeleton placeholders
    function showSkeleton(count = 4) {
      CONTAINER.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const sk = document.createElement('div');
        sk.className = 'skeleton';
        sk.textContent = '...';
        CONTAINER.appendChild(sk);
      }
    }

    // Fetch all pages of repos (per_page=100) until empty or MAX_PAGES
    async function fetchAllRepos(username) {
      const headers = {
        'Accept': 'application/vnd.github+json'
      };
      if (GITHUB_TOKEN) {
        headers.Authorization = 'Bearer ' + GITHUB_TOKEN;
      }

      let page = 1;
      let all = [];
      while (page <= MAX_PAGES) {
        const url = `https://api.github.com/users/${encodeURIComponent(username)}/repos?per_page=${PER_PAGE}&page=${page}&sort=updated`;
        const resp = await fetch(url, { headers });
        // Handle rate limit
        if (resp.status === 403) {
          const remaining = resp.headers.get('X-RateLimit-Remaining');
          const reset = resp.headers.get('X-RateLimit-Reset');
          let msg = 'Доступ к GitHub API ограничен (rate limit).';
          if (remaining !== null) msg += ` Осталось запросов: ${remaining}.`;
          if (reset) {
            const resetDate = new Date(Number(reset) * 1000);
            msg += ` Сброс: ${resetDate.toLocaleString()}.`;
          }
          throw new Error(msg);
        }
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status} (${resp.statusText})`);
        }
        const repos = await resp.json();
        if (!Array.isArray(repos)) break;
        all = all.concat(repos);
        if (repos.length < PER_PAGE) break; // last page
        page++;
      }
      return all;
    }

    // Caching helpers
    function saveCache(username, repos) {
      try {
        const payload = { username, ts: Date.now(), repos };
        localStorage.setItem(STORAGE_KEY + '_' + username, JSON.stringify(payload));
      } catch (e) { /* ignore */ }
    }
    function loadCache(username) {
      try {
        const raw = localStorage.getItem(STORAGE_KEY + '_' + username);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || parsed.username !== username) return null;
        if ((Date.now() - parsed.ts) > CACHE_TTL_MS) return null;
        return parsed.repos || null;
      } catch (e) { return null; }
    }
    function clearCache(username) {
      localStorage.removeItem(STORAGE_KEY + '_' + username);
    }

    // Main render flow
    async function loadAndRender(username, useCache = true) {
      CONTAINER.innerHTML = '';
      setStatus('Загрузка репозиториев…', true);
      showSkeleton(6);

      try {
        // try cache first
        const cached = useCache ? loadCache(username) : null;
        if (cached) {
          setStatus('Загружено из кеша.');
          renderRepos(cached);
          return;
        }

        const repos = await fetchAllRepos(username);
        if (!repos || repos.length === 0) {
          setStatus('Репозитории не найдены.');
          CONTAINER.innerHTML = '';
          COUNTER.textContent = '';
          return;
        }

        // save cache
        saveCache(username, repos);
        setStatus(`Загружено ${repos.length} репозиториев.`);
        renderRepos(repos);
      } catch (err) {
        console.error(err);
        setStatus('Ошибка: ' + (err.message || 'Не удалось загрузить репозитории.'));
        CONTAINER.innerHTML = '';
      }
    }

    function renderRepos(repos) {
      CONTAINER.innerHTML = '';
      repos.forEach(r => CONTAINER.appendChild(createProjectNode(r)));
      COUNTER.textContent = repos.length + ' repos';
    }

    // Events
    RELOAD_BTN.addEventListener('click', () => {
      const username = USERNAME_INPUT.value.trim();
      if (!username) { setStatus('Введите username.'); return; }
      // force reload, ignore cache
      loadAndRender(username, false);
    });
    CLEAR_BTN.addEventListener('click', () => {
      const username = USERNAME_INPUT.value.trim();
      if (!username) return;
      clearCache(username);
      setStatus('Кеш очищен.');
    });

    // Initial load
    (function init() {
      const username = USERNAME_INPUT.value.trim();
      if (!username) { setStatus('Введите username.'); return; }
      loadAndRender(username, true);
    })();

  })();
  </script>
</body>
</html>

